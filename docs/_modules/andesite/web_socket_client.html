
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>andesite.web_socket_client &#8212; andesite.py 0.2.3 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="canonical" href="/andesite.py/docs/_modules/andesite/web_socket_client.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for andesite.web_socket_client</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Web socket client for Andesite.</span>

<span class="sd">Use `WebSocket` if you just want a client which</span>
<span class="sd">connects to a single Andesite node.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">suppress</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="k">import</span> <span class="n">JSONDecodeError</span><span class="p">,</span> <span class="n">JSONDecoder</span><span class="p">,</span> <span class="n">JSONEncoder</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">overload</span>

<span class="kn">import</span> <span class="nn">aiobservable</span>
<span class="kn">import</span> <span class="nn">websockets</span>
<span class="kn">from</span> <span class="nn">websockets</span> <span class="k">import</span> <span class="n">ConnectionClosed</span><span class="p">,</span> <span class="n">InvalidHandshake</span><span class="p">,</span> <span class="n">WebSocketClientProtocol</span>
<span class="kn">from</span> <span class="nn">websockets.http</span> <span class="k">import</span> <span class="n">Headers</span>
<span class="kn">from</span> <span class="nn">yarl</span> <span class="k">import</span> <span class="n">URL</span>

<span class="kn">import</span> <span class="nn">andesite</span>
<span class="kn">from</span> <span class="nn">.transform</span> <span class="k">import</span> <span class="n">build_from_raw</span><span class="p">,</span> <span class="n">convert_to_raw</span><span class="p">,</span> <span class="n">map_filter_none</span><span class="p">,</span> <span class="n">to_centi</span><span class="p">,</span> <span class="n">to_milli</span>
<span class="kn">from</span> <span class="nn">.web_socket_client_events</span> <span class="k">import</span> <span class="n">RawMsgReceiveEvent</span><span class="p">,</span> <span class="n">RawMsgSendEvent</span><span class="p">,</span> <span class="n">WebSocketConnectEvent</span><span class="p">,</span> \
    <span class="n">WebSocketDisconnectEvent</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;try_connect&quot;</span><span class="p">,</span>
           <span class="s2">&quot;AbstractWebSocket&quot;</span><span class="p">,</span> <span class="s2">&quot;AbstractWebSocketClient&quot;</span><span class="p">,</span>
           <span class="s2">&quot;WebSocketInterface&quot;</span><span class="p">,</span>
           <span class="s2">&quot;WebSocketBase&quot;</span><span class="p">,</span>
           <span class="s2">&quot;WebSocket&quot;</span><span class="p">]</span>

<span class="n">ROPT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;ROPT&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">andesite</span><span class="o">.</span><span class="n">ReceiveOperation</span><span class="p">)</span>
<span class="n">ET</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;ET&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">andesite</span><span class="o">.</span><span class="n">AndesiteEvent</span><span class="p">)</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="try_connect"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.try_connect">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">try_connect</span><span class="p">(</span><span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">WebSocketClientProtocol</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Connect to the given uri and return the client.</span>

<span class="sd">    Catches exceptions which could potentially be solved</span>
<span class="sd">    by retrying.</span>

<span class="sd">    Args:</span>
<span class="sd">        uri: URI to connect to</span>
<span class="sd">        **kwargs: keyword arguments to pass to the `websockets.connect` function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `WebSocketClientProtocol` if the connection succeeded, None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">websockets</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">InvalidHandshake</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Connection to </span><span class="si">{uri}</span><span class="s2"> failed: </span><span class="si">{e}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">client</span></div>


<span class="k">def</span> <span class="nf">_get_ops_for_player</span><span class="p">(</span><span class="n">track</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">andesite</span><span class="o">.</span><span class="n">BasePlayer</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">andesite</span><span class="o">.</span><span class="n">Play</span><span class="p">,</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Update</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Get operations which apply the state from the given player.</span>

<span class="sd">    Two operations are required to both play the track and set the filters.</span>

<span class="sd">    Args:</span>
<span class="sd">        track: Track to play</span>
<span class="sd">        player: Player to get state from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Two operations which when sent to Andesite will apply the given player&#39;s</span>
<span class="sd">        state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">player</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">play_op</span> <span class="o">=</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Play</span><span class="p">(</span><span class="n">track</span><span class="p">,</span>
                                <span class="n">start</span><span class="o">=</span><span class="n">player</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
                                <span class="n">pause</span><span class="o">=</span><span class="n">player</span><span class="o">.</span><span class="n">paused</span><span class="p">,</span>
                                <span class="n">volume</span><span class="o">=</span><span class="n">player</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                                <span class="n">no_replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">update_op</span> <span class="o">=</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span>
            <span class="n">pause</span><span class="o">=</span><span class="n">player</span><span class="o">.</span><span class="n">paused</span><span class="p">,</span>
            <span class="n">position</span><span class="o">=</span><span class="n">player</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
            <span class="n">volume</span><span class="o">=</span><span class="n">player</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">andesite</span><span class="o">.</span><span class="n">FilterUpdate</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">filters</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">play_op</span> <span class="o">=</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Play</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
        <span class="n">update_op</span> <span class="o">=</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">play_op</span><span class="p">,</span> <span class="n">update_op</span>


<div class="viewcode-block" id="AbstractWebSocket"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.AbstractWebSocket">[docs]</a><span class="k">class</span> <span class="nc">AbstractWebSocket</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for an Andesite web socket client.</span>

<span class="sd">    This class is separate from `AbstractWebSocketClient` to</span>
<span class="sd">    support more complex clients which use more than one web socket</span>
<span class="sd">    connection (ex: Pools).</span>

<span class="sd">    See Also:</span>
<span class="sd">        `AbstractWebSocketClient` for the abstract base class</span>
<span class="sd">        for actual web socket clients.</span>


<span class="sd">    :Events:</span>
<span class="sd">        - **ws_connect** (`WebSocketConnectEvent`): When the client connects</span>
<span class="sd">        - **ws_disconnect** (`WebSocketDisconnectEvent`): When the client</span>
<span class="sd">          disconnects</span>

<span class="sd">        - **raw_msg_receive** (`RawMsgReceiveEvent`): Whenever a message body is</span>
<span class="sd">          received. For this event to be dispatched, the received message needs</span>
<span class="sd">          to be valid JSON and an object.</span>
<span class="sd">        - **raw_msg_send** (`RawMsgSendEvent`): When sending a message.</span>
<span class="sd">          This event is dispatched regardless of whether the message</span>
<span class="sd">          was actually sent.</span>

<span class="sd">        - **player_update** (`PlayerUpdate`): When a `PlayerUpdate` is received.</span>

<span class="sd">        - **track_start** (`TrackStartEvent`)</span>
<span class="sd">        - **track_end** (`TrackEndEvent`)</span>
<span class="sd">        - **track_exception** (`TrackExceptionEvent`)</span>
<span class="sd">        - **track_stuck** (`TrackStuckEvent`)</span>
<span class="sd">        - **unknown_andesite_event** (`UnknownAndesiteEvent`): When an unknown</span>
<span class="sd">          event is received.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__event_target</span><span class="p">:</span> <span class="n">aiobservable</span><span class="o">.</span><span class="n">Observable</span>
    <span class="n">__state_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">andesite</span><span class="o">.</span><span class="n">AbstractState</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">event_target</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">aiobservable</span><span class="o">.</span><span class="n">Observable</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Event target to send events to.</span>

<span class="sd">        If no event target is set, but the instance is itself an event target,</span>
<span class="sd">        self is set as the new event target and returned, otherwise a new event</span>
<span class="sd">        target is created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_target</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aiobservable</span><span class="o">.</span><span class="n">Observable</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__event_target</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__event_target</span> <span class="o">=</span> <span class="n">aiobservable</span><span class="o">.</span><span class="n">Observable</span><span class="p">()</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_target</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">andesite</span><span class="o">.</span><span class="n">AbstractState</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;State handler for the client.</span>

<span class="sd">        You may manually set this value to a different state handler which</span>
<span class="sd">        implements the `AbstractState`. You can also disable state handling</span>
<span class="sd">        by setting it to `False`.</span>
<span class="sd">        Note that this won&#39;t apply the state to the client! You can use the</span>
<span class="sd">        `load_player_state` method do load individual player states.</span>

<span class="sd">        If not state is set the getter either returns the current instance, if</span>
<span class="sd">        it happens to implement `AbstractState`, otherwise it returns</span>
<span class="sd">        `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__state_handler</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">andesite</span><span class="o">.</span><span class="n">AbstractState</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__state_handler</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__state_handler</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__state_handler</span>

    <span class="nd">@state</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">StateArgumentType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__state_handler</span> <span class="o">=</span> <span class="n">andesite</span><span class="o">.</span><span class="n">_get_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Whether or not the client is closed.</span>

<span class="sd">        If the client is closed it is no longer usable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

<div class="viewcode-block" id="AbstractWebSocket.close"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.AbstractWebSocket.close">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close the underlying connections and clean up.</span>

<span class="sd">        This should be called when you no longer need the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span></div>

<div class="viewcode-block" id="AbstractWebSocket.reset"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.AbstractWebSocket.reset">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reset the client so it may be used again.</span>

<span class="sd">        This has the opposite effect of the `close` method making the client</span>
<span class="sd">        usable again.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span></div>

<div class="viewcode-block" id="AbstractWebSocket.send"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.AbstractWebSocket.send">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Send a payload.</span>

<span class="sd">        The guild_id and op are written to the payload before it is converted</span>
<span class="sd">        to JSON.</span>

<span class="sd">        If sending the message fails because the connection is closed, the</span>
<span class="sd">        client attempts to connect and then sends the message again.</span>

<span class="sd">        Regardless of whether the payload was actually sent or</span>
<span class="sd">        not a `RawMsgSendEvent` (`raw_msg_send`) event is dispatched.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: Target guild id</span>
<span class="sd">            op: Name of operation to perform</span>
<span class="sd">            payload: Additional data to be sent along with the data.</span>
<span class="sd">                The payload is mutated by the function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span></div>

<div class="viewcode-block" id="AbstractWebSocket.send_operation"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.AbstractWebSocket.send_operation">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">SendOperation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Send a `SendOperation`.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: Target guild id</span>
<span class="sd">            operation: Operation to send</span>

<span class="sd">        Notes:</span>
<span class="sd">            Using `SendOperation` instances to send messages is slightly</span>
<span class="sd">            less efficient than calling the respective `WebSocket` methods</span>
<span class="sd">            directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="n">operation</span><span class="o">.</span><span class="n">__op__</span><span class="p">,</span> <span class="n">convert_to_raw</span><span class="p">(</span><span class="n">operation</span><span class="p">))</span></div>

<div class="viewcode-block" id="AbstractWebSocket.load_player_state"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.AbstractWebSocket.load_player_state">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">load_player_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">player_state</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">AbstractPlayerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load a player state.</span>

<span class="sd">        Args:</span>
<span class="sd">            player_state: State to load.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">guild_id</span> <span class="o">=</span> <span class="n">player_state</span><span class="o">.</span><span class="n">guild_id</span>

        <span class="n">last_update</span> <span class="o">=</span> <span class="k">await</span> <span class="n">player_state</span><span class="o">.</span><span class="n">get_voice_server_update</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">last_update</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_operation</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="n">last_update</span><span class="p">)</span>

        <span class="c1"># TODO can we do mixer players?</span>

        <span class="n">track</span><span class="p">,</span> <span class="n">player</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="n">player_state</span><span class="o">.</span><span class="n">get_track</span><span class="p">(),</span>
            <span class="n">player_state</span><span class="o">.</span><span class="n">get_player</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">track</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">last_update</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;loading player state without voice server update! (</span><span class="si">{self}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># of course because Andesite is... great [citation needed] we need</span>
            <span class="c1"># to use two operations to set it up properly...</span>
            <span class="n">play_op</span><span class="p">,</span> <span class="n">update_op</span> <span class="o">=</span> <span class="n">_get_ops_for_player</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">player</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_operation</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="n">play_op</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_operation</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="n">update_op</span><span class="p">),</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="AbstractWebSocketClient"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.AbstractWebSocketClient">[docs]</a><span class="k">class</span> <span class="nc">AbstractWebSocketClient</span><span class="p">(</span><span class="n">AbstractWebSocket</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for a singular web socket connection to Andesite.</span>

<span class="sd">    If you&#39;re creating a new client and it doesn&#39;t use only one Andesite node,</span>
<span class="sd">    you should implement `AbstractWebSocket` instead.</span>

<span class="sd">    See Also:</span>
<span class="sd">        `AbstractWebSocket` for more details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Whether the client is connected and usable.&quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">connection_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Andesite connection id.</span>

<span class="sd">        This should be set after connecting to the node.</span>
<span class="sd">        The connection id can be used to resume connections.</span>

<span class="sd">        This property is deletable. The consequence of which is that it won&#39;t</span>
<span class="sd">        be sent the next time the client connects to a node.</span>

<span class="sd">        Notes:</span>
<span class="sd">            The client already performs resuming automatically.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">node_region</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Node region sent by the Andesite node.</span>

<span class="sd">        This will be set after the connection is established.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">node_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Node id sent by the Andesite node.</span>

<span class="sd">        This will be set after the connection is established.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

<div class="viewcode-block" id="AbstractWebSocketClient.connect"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.AbstractWebSocketClient.connect">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Connect to the web socket server.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_attempts: Amount of connection attempts to perform before aborting.</span>
<span class="sd">                If `None`, unlimited attempts will be performed.</span>

<span class="sd">        If `max_attempts` is exceeded and the client gives up on connecting it</span>
<span class="sd">        is closed!</span>

<span class="sd">        After successfully connecting all messages in the message</span>
<span class="sd">        queue are sent in the order they were added and a `ws_connected`</span>
<span class="sd">        event is dispatched.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method doesn&#39;t have to be called manually,</span>
<span class="sd">            it is called as soon as the first message needs to be sent.</span>
<span class="sd">            However, there are good reasons to call it anyway, such</span>
<span class="sd">            as the ability to check the validity of the URI, or to</span>
<span class="sd">            receive events from Andesite.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span></div>

<div class="viewcode-block" id="AbstractWebSocketClient.disconnect"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.AbstractWebSocketClient.disconnect">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Disconnect the web socket.</span>

<span class="sd">        This will also stop the client from</span>
<span class="sd">        receiving events from Andesite.</span>

<span class="sd">        This method is idempotent, it doesn&#39;t do</span>
<span class="sd">        anything if the client isn&#39;t connected.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This is different from `close`. Calling `close`</span>
<span class="sd">            disconnects the client and causes it to become unusable.</span>
<span class="sd">            This method only disconnects the client so it can be reconnected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span></div></div>


<div class="viewcode-block" id="WebSocketInterface"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface">[docs]</a><span class="k">class</span> <span class="nc">WebSocketInterface</span><span class="p">(</span><span class="n">AbstractWebSocket</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implementation of the web socket endpoints.&quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for_receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">ROPT</span><span class="p">],</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ROPT</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">guild_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">predicate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">predicate</span><span class="p">(</span><span class="n">op</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">ReceiveOperation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># noinspection PyUnresolvedReferences</span>
                    <span class="n">gid</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">guild_id</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="k">return</span> <span class="n">gid</span> <span class="o">==</span> <span class="n">guild_id</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_target</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">op_type</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="n">predicate</span><span class="o">=</span><span class="n">predicate</span><span class="p">)</span>

    <span class="c1"># noinspection PyOverloads</span>
    <span class="nd">@overload</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">track</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Play</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">track</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                   <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">end</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">pause</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">no_replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>

<div class="viewcode-block" id="WebSocketInterface.play"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface.play">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">track</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Play</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span>
                   <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">end</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">pause</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">no_replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Play a track on the guild.</span>

<span class="sd">        Instead of providing all the fields you can also pass a `Play` operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: ID of the guild for which to play</span>
<span class="sd">            track: Either a `Play` operation or a base64 encoded lavaplayer track.</span>
<span class="sd">                If you pass a `Play` operation you must not set any of the</span>
<span class="sd">                keyword arguments.</span>

<span class="sd">            start: timestamp, in seconds, to start the track</span>
<span class="sd">            end: timestamp, in seconds, to end the track</span>
<span class="sd">            pause: whether or not to pause the player</span>
<span class="sd">            volume: volume to set on the player</span>
<span class="sd">            no_replace: if True and a track is already playing/paused,</span>
<span class="sd">                this command is ignored (Default: False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Play</span><span class="p">):</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">convert_to_raw</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">track</span><span class="o">=</span><span class="n">track</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">to_milli</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="n">to_milli</span><span class="p">(</span><span class="n">end</span><span class="p">),</span> <span class="n">pause</span><span class="o">=</span><span class="n">pause</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="n">to_centi</span><span class="p">(</span><span class="n">volume</span><span class="p">),</span>
                           <span class="n">noReplace</span><span class="o">=</span><span class="n">no_replace</span><span class="p">)</span>
            <span class="n">map_filter_none</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;play&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span></div>

<div class="viewcode-block" id="WebSocketInterface.pause"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface.pause">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">pause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">pause</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Pause a player.</span>

<span class="sd">        If the player is already paused or unpaused,</span>
<span class="sd">        this is a no-op.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: ID of the guild for which to pause</span>
<span class="sd">            pause: `True` to pause, `False` to unpause</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;pause&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pause</span><span class="o">=</span><span class="n">pause</span><span class="p">))</span></div>

<div class="viewcode-block" id="WebSocketInterface.stop"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface.stop">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stop a player.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: ID of the guild for which to stop</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="p">{})</span></div>

<div class="viewcode-block" id="WebSocketInterface.seek"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface.seek">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Seek to a position.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: ID of the guild for which to seek</span>
<span class="sd">            position: Timestamp, in seconds, to seek to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">to_milli</span><span class="p">(</span><span class="n">position</span><span class="p">))</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;seek&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span></div>

<div class="viewcode-block" id="WebSocketInterface.volume"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface.volume">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set a player&#39;s volume.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: ID of the guild for which to set the volume</span>
<span class="sd">            volume: Volume to set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">volume</span><span class="o">=</span><span class="n">to_centi</span><span class="p">(</span><span class="n">volume</span><span class="p">))</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span></div>

    <span class="nd">@overload</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Update</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                     <span class="n">pause</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">position</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">filters</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">FilterMapLike</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>

<div class="viewcode-block" id="WebSocketInterface.update"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface.update">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Update</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                     <span class="n">pause</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">position</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">filters</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">FilterMapLike</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Send an update.</span>

<span class="sd">        You may either provide the given keyword arguments,</span>
<span class="sd">        or pass an `Update` operation which will be used instead.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: ID of the guild for which to update.</span>
<span class="sd">            update: You can provide an `Update` operation instead of</span>
<span class="sd">                the keyword arguments.</span>

<span class="sd">            pause: whether or not to pause the player</span>
<span class="sd">            position: timestamp to set the current track to, in seconds</span>
<span class="sd">            volume: volume to set on the player</span>
<span class="sd">            filters: configuration for the filters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Update</span><span class="p">):</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">convert_to_raw</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filters</span><span class="p">:</span>
                <span class="n">filters</span> <span class="o">=</span> <span class="n">convert_to_raw</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pause</span><span class="o">=</span><span class="n">pause</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">to_milli</span><span class="p">(</span><span class="n">position</span><span class="p">),</span> <span class="n">volume</span><span class="o">=</span><span class="n">to_centi</span><span class="p">(</span><span class="n">volume</span><span class="p">),</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
            <span class="n">map_filter_none</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span></div>

<div class="viewcode-block" id="WebSocketInterface.destroy"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface.destroy">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Destroy a player.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: ID of the guild for which to destroy the player</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;destroy&quot;</span><span class="p">,</span> <span class="p">{})</span></div>

<div class="viewcode-block" id="WebSocketInterface.mixer"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface.mixer">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">mixer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">enable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">players</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">andesite</span><span class="o">.</span><span class="n">Play</span><span class="p">,</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Update</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Configure the mixer player.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: ID of the guild for which to configure the mixer</span>
<span class="sd">            enable: If present, controls whether or not the mixer should be used</span>
<span class="sd">            **players: Map of player id to `Play` / `Update` payloads for each mixer source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_to_raw</span><span class="p">(</span><span class="n">players</span><span class="p">)</span>
        <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;enable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">enable</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;mixer&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span></div>

    <span class="nd">@overload</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">filter_update</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">FilterMap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                      <span class="n">equalizer</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Equalizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">karaoke</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Karaoke</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">timescale</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Timescale</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">tremolo</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Tremolo</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">vibrato</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Vibrato</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">volume</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">VolumeFilter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>

<div class="viewcode-block" id="WebSocketInterface.filters"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface.filters">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">filter_update</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">FilterMap</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                      <span class="n">equalizer</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Equalizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">karaoke</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Karaoke</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">timescale</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Timescale</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">tremolo</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Tremolo</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">vibrato</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Vibrato</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">volume</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">VolumeFilter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">custom_filters</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Configure the filters of a player.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: ID of the guild for which to configure the filters</span>
<span class="sd">            filter_update: Instead of specifying the other keyword arguments</span>
<span class="sd">                you may provide a `FilterMap` operation which will be used</span>
<span class="sd">                instead.</span>
<span class="sd">            equalizer: Equalizer filter settings</span>
<span class="sd">            karaoke: Karaoke filter settings</span>
<span class="sd">            timescale: Timescale filter settings</span>
<span class="sd">            tremolo: Tremolo filter settings</span>
<span class="sd">            vibrato: Vibrato filter settings</span>
<span class="sd">            volume: Volume filter settings</span>
<span class="sd">            **custom_filters: Ability to specify additional filters</span>
<span class="sd">                that aren&#39;t supported by the library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_update</span><span class="p">,</span> <span class="n">andesite</span><span class="o">.</span><span class="n">FilterUpdate</span><span class="p">):</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">convert_to_raw</span><span class="p">(</span><span class="n">filter_update</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">convert_to_raw</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">equalizer</span><span class="o">=</span><span class="n">equalizer</span><span class="p">,</span>
                <span class="n">karaoke</span><span class="o">=</span><span class="n">karaoke</span><span class="p">,</span>
                <span class="n">timescale</span><span class="o">=</span><span class="n">timescale</span><span class="p">,</span>
                <span class="n">tremolo</span><span class="o">=</span><span class="n">tremolo</span><span class="p">,</span>
                <span class="n">vibrato</span><span class="o">=</span><span class="n">vibrato</span><span class="p">,</span>
                <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">,</span>
                <span class="o">**</span><span class="n">custom_filters</span>
            <span class="p">))</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;filters&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span></div>

<div class="viewcode-block" id="WebSocketInterface.get_player"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface.get_player">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_player</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">andesite</span><span class="o">.</span><span class="n">Player</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the player.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: Target guild id</span>

<span class="sd">        Returns:</span>
<span class="sd">            Player state for the guild. This may be `None` if no player</span>
<span class="sd">            is available yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;get-player&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">player_update</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_receive</span><span class="p">(</span><span class="n">andesite</span><span class="o">.</span><span class="n">PlayerUpdate</span><span class="p">,</span> <span class="n">guild_id</span><span class="o">=</span><span class="n">guild_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">player_update</span><span class="o">.</span><span class="n">state</span></div>

<div class="viewcode-block" id="WebSocketInterface.get_stats"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface.get_stats">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">andesite</span><span class="o">.</span><span class="n">Stats</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the Andesite stats.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: Target guild id</span>

<span class="sd">        Returns:</span>
<span class="sd">            Statistics for the node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;get-stats&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">stats_update</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_receive</span><span class="p">(</span><span class="n">andesite</span><span class="o">.</span><span class="n">StatsUpdate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stats_update</span><span class="o">.</span><span class="n">stats</span></div>

<div class="viewcode-block" id="WebSocketInterface.ping"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface.ping">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Ping the Andesite server.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: Target guild id</span>

<span class="sd">        Returns:</span>
<span class="sd">            Amount of seconds it took for the response to be received.</span>
<span class="sd">            Note: This is not necessarily an accurate reflection of the actual latency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;ping&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_receive</span><span class="p">(</span><span class="n">andesite</span><span class="o">.</span><span class="n">PongResponse</span><span class="p">,</span> <span class="n">guild_id</span><span class="o">=</span><span class="n">guild_id</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span></div>

<div class="viewcode-block" id="WebSocketInterface.voice_server_update"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketInterface.voice_server_update">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">voice_server_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Provide a voice server update.</span>

<span class="sd">        Args:</span>
<span class="sd">            guild_id: ID of the guild of the voice server update</span>
<span class="sd">            session_id: session id</span>
<span class="sd">            event: voice server update event as sent by Discord</span>

<span class="sd">        Notes:</span>
<span class="sd">            If you wish to send a `VoiceServerUpdate` operation, please</span>
<span class="sd">            use the `send_operation` method directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sessionId</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;voice-server-update&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="WebSocketBase"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketBase">[docs]</a><span class="k">class</span> <span class="nc">WebSocketBase</span><span class="p">(</span><span class="n">AbstractWebSocketClient</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Client for the Andesite WebSocket handler.</span>

<span class="sd">    Args:</span>
<span class="sd">        ws_uri: Websocket endpoint to connect to.</span>
<span class="sd">        user_id: Bot&#39;s user id. If at the time of creation this is unknown,</span>
<span class="sd">            you may pass `None`, but then it needs to be set before connecting</span>
<span class="sd">            for the first time.</span>
<span class="sd">        password: Authorization for the Andesite node.</span>
<span class="sd">            Set to `None` if the node doesn&#39;t have a password.</span>
<span class="sd">        state: State handler to use. If `False` state handling is disabled.</span>
<span class="sd">            `None` to use the default state handler (`State`).</span>
<span class="sd">        max_connect_attempts: See the `max_connect_attempts` attribute.</span>

<span class="sd">    The client automatically keeps track of the current connection id and</span>
<span class="sd">    resumes the previous connection when calling `connect`, if there is any.</span>
<span class="sd">    You can delete the `connection_id` property to disable this.</span>

<span class="sd">    See Also:</span>
<span class="sd">        `AbstractWebSocketClient` for more details including a list</span>
<span class="sd">        of events that are dispatched.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        max_connect_attempts (Optional[int]): Max amount of connection attempts</span>
<span class="sd">            to start before giving up. If `None`, there is no upper limit.</span>
<span class="sd">            This value can be overwritten when calling `connect` manually.</span>
<span class="sd">        web_socket_client (Optional[WebSocketClientProtocol]):</span>
<span class="sd">            Web socket client which is used.</span>
<span class="sd">            This attribute will be set once `connect` is called.</span>
<span class="sd">            Don&#39;t use the presence of this attribute to check whether</span>
<span class="sd">            the client is connected, use the `connected` property.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_connect_attempts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

    <span class="n">web_socket_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">WebSocketClientProtocol</span><span class="p">]</span>

    <span class="n">__closed</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="n">__ws_uri</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">__headers</span><span class="p">:</span> <span class="n">Headers</span>
    <span class="n">__last_connection_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="n">__connect_lock</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">]</span>

    <span class="n">__read_loop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">]</span>

    <span class="n">_json_encoder</span><span class="p">:</span> <span class="n">JSONEncoder</span>
    <span class="n">_json_decoder</span><span class="p">:</span> <span class="n">JSONDecoder</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws_uri</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">URL</span><span class="p">],</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">state</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">StateArgumentType</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">max_connect_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ws_uri</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ws_uri</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__last_connection_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_connect_attempts</span> <span class="o">=</span> <span class="n">max_connect_attempts</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">web_socket_client</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># can&#39;t create the lock here, because if the user uses</span>
        <span class="c1"># asyncio.run and creates the client outside of it, the loop</span>
        <span class="c1"># within the lock will not be the same as the loop used by</span>
        <span class="c1"># asyncio.run (as it creates a new loop every time)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__connect_lock</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__read_loop</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_json_encoder</span> <span class="o">=</span> <span class="n">JSONEncoder</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_json_decoder</span> <span class="o">=</span> <span class="n">JSONDecoder</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;{type(self).__name__}(ws_uri=</span><span class="si">{self.__ws_uri!r}</span><span class="s2">, user_id=</span><span class="si">{self.user_id!r}</span><span class="s2">, &quot;</span> \
               <span class="n">f</span><span class="s2">&quot;password=[HIDDEN], state=</span><span class="si">{self.state!r}</span><span class="s2">, max_connect_attempts=</span><span class="si">{self.max_connect_attempts!r}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;{type(self).__name__}(</span><span class="si">{self.__ws_uri}</span><span class="s2">)&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;User id.</span>

<span class="sd">        This is only `None` if it wasn&#39;t passed to the constructor.</span>

<span class="sd">        You can set this property to a new user id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;User-Id&quot;</span><span class="p">)</span>

    <span class="nd">@user_id</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">user_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span><span class="p">[</span><span class="s2">&quot;User-Id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">web_socket_client</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">web_socket_client</span><span class="o">.</span><span class="n">open</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connection_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__last_connection_id</span>

    <span class="nd">@connection_id</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">connection_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__last_connection_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">node_region</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">web_socket_client</span>
        <span class="k">if</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">response_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Andesite-Node-Region&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">node_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">web_socket_client</span>
        <span class="k">if</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">response_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Andesite-Node-Id&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_connect_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the connect lock.</span>

<span class="sd">        The connect lock is only created once. Subsequent calls always return</span>
<span class="sd">        the same lock. The reason for the delayed creating is that the lock is</span>
<span class="sd">        bound to an event loop, which can change between __init__ and connect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__connect_lock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__connect_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__connect_lock</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Internal connect method.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_attempts: Max amount of connection attempts to perform before aborting.</span>
<span class="sd">                This overwrites the instance attribute `max_connect_attempts`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If client is already connected</span>

<span class="sd">        Notes:</span>
<span class="sd">            If `max_attempts` is exceeded and the client gives up on connecting it</span>
<span class="sd">            is closed!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Already connected!&quot;</span><span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span>

        <span class="k">if</span> <span class="s2">&quot;User-Id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Trying to connect but user id unknown.</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;This is most likely the case because you didn&#39;t</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;set the user_id in the constructor and forgot to</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;set it before connecting!&quot;</span><span class="p">)</span>

        <span class="c1"># inject the connection id to resume previous connection</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__last_connection_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Andesite-Resume-Id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__last_connection_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Andesite-Resume-Id&quot;</span><span class="p">]</span>

        <span class="n">attempt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">max_attempts</span> <span class="o">=</span> <span class="n">max_attempts</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_connect_attempts</span>

        <span class="k">while</span> <span class="n">max_attempts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">attempt</span> <span class="o">&lt;=</span> <span class="n">max_attempts</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">try_connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ws_uri</span><span class="p">,</span> <span class="n">extra_headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">client</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">attempt</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Connection unsuccessful, trying again in </span><span class="si">{timeout}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

            <span class="n">attempt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Couldn&#39;t connect to </span><span class="si">{self.__ws_uri}</span><span class="s2"> after </span><span class="si">{attempt}</span><span class="s2"> attempts&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">web_socket_client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__start_read_loop</span><span class="p">()</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_target</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">WebSocketConnectEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

<div class="viewcode-block" id="WebSocketBase.connect"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketBase.connect">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Client is closed and cannot be reused.&quot;</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connect_lock</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__connect</span><span class="p">(</span><span class="n">max_attempts</span><span class="p">)</span></div>

<div class="viewcode-block" id="WebSocketBase.disconnect"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketBase.disconnect">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stop_read_loop</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">web_socket_client</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">&quot;disconnect&quot;</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_target</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">WebSocketDisconnectEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="WebSocketBase.reset"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketBase.reset">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="WebSocketBase.close"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketBase.close">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__web_socket_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Internal web socket read loop.</span>

<span class="sd">        This method should never be called manually, see the following</span>
<span class="sd">        methods for controlling the reader.</span>

<span class="sd">        See Also:</span>
<span class="sd">            `WebSocket._start_read_loop` to start the read loop.</span>
<span class="sd">            `WebSocket._stop_read_loop` to stop the read loop.</span>

<span class="sd">        Notes:</span>
<span class="sd">            The read loop is automatically managed by the `WebSocket.connect`</span>
<span class="sd">            and `WebSocket.disconnect` methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">handle_msg</span><span class="p">(</span><span class="n">raw_msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">raw_msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Couldn&#39;t parse received JSON data in </span><span class="si">{self}</span><span class="s2">: </span><span class="si">{e}</span><span class="se">\n</span><span class="s2">msg: </span><span class="si">{raw_msg}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Received invalid message type in </span><span class="si">{self}</span><span class="s2">. &quot;</span>
                            <span class="n">f</span><span class="s2">&quot;Expecting object, received type {type(data).__name__}: </span><span class="si">{data}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_target</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">RawMsgReceiveEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;op&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Ignoring message without op code in </span><span class="si">{self}</span><span class="s2">: </span><span class="si">{data}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">event_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">andesite</span><span class="o">.</span><span class="n">get_update_model</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">event_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Ignoring message with unknown op </span><span class="se">\&quot;</span><span class="si">{op}</span><span class="se">\&quot;</span><span class="s2"> in </span><span class="si">{self}</span><span class="s2">: </span><span class="si">{data}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">message</span><span class="p">:</span> <span class="n">andesite</span><span class="o">.</span><span class="n">ReceiveOperation</span> <span class="o">=</span> <span class="n">build_from_raw</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Couldn&#39;t parse message in </span><span class="si">{self}</span><span class="s2"> from Andesite node to </span><span class="si">{cls}</span><span class="s2">: </span><span class="si">{data}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">message</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="bp">self</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">andesite</span><span class="o">.</span><span class="n">ConnectionUpdate</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;received connection update, setting last connection id in </span><span class="si">{self}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__last_connection_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">id</span>

            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_target</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_handle_andesite_message</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">raw_msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">web_socket_client</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">ConnectionClosed</span><span class="p">:</span>
                <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_target</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">WebSocketDisconnectEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Disconnected from websocket, trying to reconnect </span><span class="si">{self}</span><span class="s2">!&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Received message in </span><span class="si">{self}</span><span class="s2">: </span><span class="si">{raw_msg}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">handle_msg</span><span class="p">(</span><span class="n">raw_msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in </span><span class="si">%s</span><span class="s2"> while handling message </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">raw_msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__start_read_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Start the web socket reader.</span>

<span class="sd">        If the reader is already running, this is a no-op.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read_loop</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read_loop</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__read_loop</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__web_socket_reader</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__stop_read_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stop the web socket reader.</span>

<span class="sd">        If the reader is already stopped, this is a no-op.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read_loop</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__read_loop</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

<div class="viewcode-block" id="WebSocketBase.send"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocketBase.send">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">web_socket_client</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">web_socket_client</span><span class="o">.</span><span class="n">open</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Not connected, connecting.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

        <span class="n">payload</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">guildId</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">guild_id</span><span class="p">),</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: sending payload: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_target</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">RawMsgSendEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">web_socket_client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ConnectionClosed</span><span class="p">:</span>
            <span class="c1"># let the websocket reader handle this</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: couldn&#39;t send message because the connection is closed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">_handle_sent_message</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="WebSocket"><a class="viewcode-back" href="../../reference/clients.html#andesite.combined_client.WebSocket">[docs]</a><span class="k">class</span> <span class="nc">WebSocket</span><span class="p">(</span><span class="n">WebSocketBase</span><span class="p">,</span> <span class="n">aiobservable</span><span class="o">.</span><span class="n">Observable</span><span class="p">,</span> <span class="n">WebSocketInterface</span><span class="p">):</span>
    <span class="o">...</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">andesite.py</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick-start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Overview</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Giesela Inc..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>